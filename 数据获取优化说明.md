# 数据获取优化说明

## 问题分析

根据代码分析，159857光伏ETF和HST00011恒生科技数据获取失败的主要原因：

### 1. 159857光伏ETF问题
- **原因**: 这是一个ETF基金，不是指数，需要使用不同的API接口
- **解决方案**: 已添加专门的ETF数据获取方法 `_fetch_etf_data()`

### 2. HST00011恒生科技问题  
- **原因**: 港股数据源不稳定，单一数据源容易失败
- **解决方案**: 已添加多个备用数据源（雅虎财经、新浪财经、腾讯财经）

## 优化内容

### 1. 新增ETF数据获取支持
```python
def _fetch_etf_data(self, index_code, start_date, end_date):
    """获取ETF数据，支持东方财富和腾讯两个数据源"""
```

### 2. 增强港股数据获取
```python
def _fetch_from_hk(self, index_code, start_date, end_date):
    """获取港股指数数据，支持多个数据源"""
    # 1. 雅虎财经 (主要)
    # 2. 新浪财经 (备用)  
    # 3. 腾讯财经 (备用)
```

### 3. 改进的数据源映射
- 159857 -> 深交所ETF接口 (0.159857)
- HST00011 -> 多个港股数据源

## 使用方法

### 1. 运行诊断工具
```bash
python diagnose_data_issues.py
```
这个工具会：
- 测试网络连接
- 测试各个API接口
- 验证数据源集成
- 提供详细的诊断报告

### 2. 运行简单测试
```bash
python simple_test.py
```
快速测试关键API是否可用

### 3. 运行完整测试
```bash
python test_data_fetch.py
```
测试完整的数据获取流程

## 技术细节

### ETF数据获取流程
1. 首先尝试东方财富ETF接口
2. 如果失败，尝试腾讯财经接口
3. 返回标准化的DataFrame格式

### 港股数据获取流程
1. 雅虎财经 (^HSTECH)
2. 新浪财经 (rt_hkHSTECH) 
3. 腾讯财经 (hkHSTECH)
4. 自动故障转移，确保数据可用性

### 数据格式标准化
所有数据源返回统一格式：
```python
{
    'trade_date': datetime,
    'open': float,
    'high': float, 
    'low': float,
    'close': float,
    'volume': float
}
```

## 注意事项

1. **网络环境**: 确保能访问相关金融数据网站
2. **请求频率**: 避免过于频繁的请求，可能被限制
3. **数据延迟**: 不同数据源可能有不同的数据更新时间
4. **缓存机制**: 已实现1小时缓存，避免重复请求

## 故障排除

如果仍然无法获取数据：

1. 检查网络连接
2. 确认防火墙设置
3. 尝试更换数据源
4. 查看详细日志信息

## 依赖包要求

```bash
pip install pandas requests
```

## 测试结果预期

正常情况下应该看到：
- ✅ 159857光伏ETF数据获取成功
- ✅ HST00011恒生科技数据获取成功
- 显示最新价格和交易数据