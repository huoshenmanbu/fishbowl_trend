<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>鱼盆趋势 — 趋势结果</title>
  <style>
    /* 基础样式 */
    :root {
      --primary-color: #1f8ef1;
      --success-color: #0f9d58;
      --error-color: #e53935;
      --border-color: #d1d5db;
      --text-muted: #6b7280;
      --red-text: #f44336;
      --green-text: #00b050;
      --blue-link: #0066cc;
      --yellow-bg: #fffbe6; /* Softer yellow for highlight */
      --gray-bg: #f8f9fa;
      --header-bg-start: #e0e7ef; /* Lighter blue-gray for header */
      --header-bg-end: #cdd7e5; /* Darker blue-gray for header */
      --yes-color: #e53935; /* Brighter red for YES */
      --no-color: #757575; /* Slightly lighter gray for NO */
      --name-color: #3f51b5; /* A more subtle blue for names */
    }
    
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background: #f6f9fb;
      color: #222;
      margin: 0;
      padding: 10px;
      -webkit-text-size-adjust: 100%;
    }

    /* 响应式卡片 */
    .card {
      max-width: 1100px;
      margin: 10px auto;
      padding: 15px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(20,30,40,0.06);
    }

    /* 标题和元信息 */
    h1 {
      margin: 0 0 6px;
      font-size: 18px;
      line-height: 1.4;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
    }

    h1 .title-text {
      flex-shrink: 0;
    }

    #update-time {
      font-size: 13px;
      font-weight: normal;
    }

    .meta {
      color: var(--text-muted);
      font-size: 13px;
      margin-bottom: 12px;
    }

    /* 控制区域 */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }

    .btn {
      background: var(--primary-color);
      color: #fff;
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      min-height: 44px;
      touch-action: manipulation;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(31, 142, 241, 0.2);
    }

    .btn:hover {
      background: #1976d2;
      box-shadow: 0 4px 8px rgba(31, 142, 241, 0.3);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(31, 142, 241, 0.2);
    }

    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .small {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* 响应式表格 */
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin: 0 -15px;
      padding: 0 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
      border: 1px solid var(--border-color);
    }

    thead th {
      background: linear-gradient(180deg, var(--header-bg-start), var(--header-bg-end));
      text-align: center;
      padding: 10px 6px;
      border: 1px solid var(--border-color);
      white-space: nowrap;
      font-size: 12px;
      font-weight: 600;
      color: #333;
    }

    tbody td {
      padding: 8px 6px;
      border: 1px solid var(--border-color);
      /* Removed truncation for full content display */
      white-space: normal; 
      overflow: visible;
      text-overflow: clip;
      text-align: left; /* Left-align all columns */
    }

    /* 斑马纹 - 偶数行 */
    tbody tr:nth-child(even) {
      background: #fafbfc;
    }

    /* 悬停效果 */
    tbody tr:hover {
      background: #f0f7ff !important;
    }

    .yes { 
      color: var(--yes-color);
      font-weight: 700;
    }
    .no { 
      color: var(--no-color);
      font-weight: 700;
    }
    .rank { 
      width: 30px; 
      text-align: center; 
      font-weight: 600;
      color: #333;
      background: var(--gray-bg);
    }
    .code { 
      width: 80px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      text-align: center;
    }
    .name {
      /* Removed max-width and truncation for full content display */
      /* max-width: 70px; */
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      color: var(--name-color); /* Use the new subtle blue */
      font-weight: 500;
    }
    .muted { color: var(--text-muted); }
    
    /* YES状态行背景 */
    .highlight {
      background: var(--yellow-bg) !important;
    }
    
    /* 涨幅颜色 */
    .price-up {
      color: var(--red-text);
      font-weight: 600;
    }
    .price-down {
      color: var(--green-text);
      font-weight: 600;
    }
    .price-zero {
      color: #666;
    }

    /* 数字列和状态列现在也左对齐 */
    .num-col {
      text-align: left;
      font-family: 'Courier New', monospace;
      padding-right: 6px !important; /* Adjust padding for left alignment */
    }

    .status-col {
      text-align: left;
      font-weight: 700;
    }

    /* Loading 动画 */
    .loader {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.4);
      border-top-color: #fff;
      animation: spin 1s linear infinite;
      vertical-align: middle;
      margin-left: 6px;
    }

    @keyframes spin { to { transform: rotate(360deg) } }

    .note {
      margin-top: 10px;
      color: var(--text-muted);
      font-size: 12px;
    }

    /* 移动端优化 */
    @media (max-width: 768px) {
      body { padding: 0; }
      .card { 
        margin: 0; 
        border-radius: 0;
        padding: 12px;
      }
      
      h1 { 
        font-size: 14px;
        margin-bottom: 4px;
        gap: 4px;
      }

      h1 .title-text {
        font-size: 14px;
      }

      #update-time {
        font-size: 11px;
        display: block;
        width: 100%;
        margin-top: 2px;
      }

      .meta {
        font-size: 11px;
        margin-bottom: 8px;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
        margin-bottom: 10px;
      }
      
      .btn {
        width: 100%;
        text-align: center;
        padding: 12px 16px;
        font-size: 14px;
      }

      .small {
        font-size: 12px;
      }

      .table-container {
        margin: 0 -12px;
        padding: 0;
      }

      table { 
        font-size: 11px;
        table-layout: fixed;
      }
      
      thead th {
        padding: 8px 4px;
        font-size: 11px;
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 10;
        text-align: left; /* Ensure mobile headers are also left-aligned */
      }

      tbody td {
        padding: 8px 4px;
      }

      /* 列宽优化 */
      .rank { 
        width: auto; /* Allow width to adjust */
        font-size: 10px;
        padding: 6px 4px !important; /* Adjust padding for left alignment */
        text-align: left;
      }
      .code { 
        width: auto; /* Allow width to adjust */
        font-size: 10px;
        text-align: left;
      }
      .name { 
        max-width: none; /* Remove max-width for full display */
        font-size: 11px;
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        text-align: left;
      }
      
      /* 数字列 */
      .num-col {
        font-size: 10px;
        padding: 6px 4px !important;
        text-align: left;
      }

      /* 状态列 */
      .status-col {
        font-size: 11px;
        padding: 6px 4px !important;
        text-align: left;
      }

      /* 隐藏不太重要的列 */
      .hide-mobile {
        display: none;
      }

      .note {
        font-size: 11px;
        margin-top: 8px;
        padding: 0 4px;
      }

      /* 状态标记更醒目 */
      .yes {
        font-size: 11px;
      }
      .no {
        font-size: 11px;
      }
    }

    /* 暗色模式支持 */
    @media (prefers-color-scheme: dark) {
      body { background: #1a1a1a; color: #e0e0e0; }
      .card { background: #242424; box-shadow: 0 6px 18px rgba(0,0,0,0.2); }
      thead th { 
        background: #2a2a2a; 
        border-color: #444;
        color: #e0e0e0;
      }
      tbody td { 
        border-color: #3a3a3a;
      }
      tbody tr:nth-child(even) {
        background: #2a2a2a;
      }
      tbody tr:hover {
        background: #333 !important;
      }
      .highlight { 
        background: rgba(255,250,205,0.1) !important;
      }
      .rank {
        background: #2a2a2a;
      }
      .name {
        color: #4da6ff;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>
      <span class="title-text">鱼盆趋势模型 v2.0</span>
      <span class="muted" id="update-time"></span>
    </h1>
    <div class="meta">数据仅供市场风格趋势分析，不提供投资建议</div>

    <div class="controls">
      <button id="refreshBtn" class="btn">获取最新趋势 <span id="loadingIcon" class="loader" style="display:none"></span></button>
      <div id="status" class="small muted"> </div>
    </div>

    <div class="table-container">
      <table id="resultTable">
        <thead>
          <tr>
            <th>排名</th>
            <th>代码</th>
            <th>名称</th>
            <th>状态</th>
            <th>涨幅%</th>
            <th>现价</th>
            <th>临界点</th>
            <th>偏离率</th>
            <th class="hide-mobile">状态转变</th>
            <th class="hide-mobile">区间涨幅%</th>
          </tr>
        </thead>
        <tbody>
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </div>

    <div class="note">表格来自本地文件 <code>data/trend_status/latest_trend_result.json</code></div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const tbody = document.querySelector('#resultTable tbody');
    const updateTimeEl = document.getElementById('update-time');

    // 显示数据的函数
    async function displayData(data) {
      if(!data) {
        statusEl.textContent = '未找到数据文件';
        return;
      }

      // 格式化更新时间显示
      const updateTime = data.update_time || '';
      const timeMatch = updateTime.match(/\d{2}:\d{2}:\d{2}/);
      const timeStr = timeMatch ? timeMatch[0] : updateTime;
      updateTimeEl.textContent = timeStr ? ` — ${timeStr}` : '';
      tbody.innerHTML = '';
      const rows = data.results || [];
      rows.sort((a,b)=> (a.rank||0)-(b.rank||0));
      
      for(const r of rows){
        const tr = document.createElement('tr');
        if(r.status === 'YES') tr.classList.add('highlight');

        // 判断涨跌颜色
        const priceChange = r.price_change_pct || 0;
        const priceClass = priceChange > 0 ? 'price-up' : (priceChange < 0 ? 'price-down' : 'price-zero');
        const priceSign = priceChange > 0 ? '+' : '';
        
        const intervalChange = r.interval_change_pct || 0;
        const intervalClass = intervalChange > 0 ? 'price-up' : (intervalChange < 0 ? 'price-down' : 'price-zero');
        const intervalSign = intervalChange > 0 ? '+' : '';

        tr.innerHTML = `
          <td class="rank">${r.rank ?? ''}</td>
          <td class="code">${r.index_code ?? ''}</td>
          <td class="name" title="${r.index_name ?? ''}">${r.index_name ?? ''}</td>
          <td class="status-col ${r.status==='YES'?'yes':'no'}">${r.status ?? ''}</td>
          <td class="num-col ${priceClass}">${priceSign}${(r.price_change_pct!=null? r.price_change_pct.toFixed(2): '')}%</td>
          <td class="num-col">${(r.current_price!=null? r.current_price.toFixed(2): '')}</td>
          <td class="num-col">${(r.threshold!=null? r.threshold.toFixed(2): '')}</td>
          <td class="num-col">${(r.deviation_rate!=null? r.deviation_rate.toFixed(2): '')}%</td>
          <td class="hide-mobile">${r.status_change_time || ''}</td>
          <td class="hide-mobile num-col ${intervalClass}">${intervalSign}${(r.interval_change_pct!=null? r.interval_change_pct.toFixed(2): '')}%</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // 加载历史数据（不重新计算）
    async function loadLatest() {
      try {
        const res = await fetch('/api/latest');
        const j = await res.json();
        if(j.ok && j.data) {
          // 保存初始更新时间
          window.initialUpdateTime = j.data.update_time;
          await displayData(j.data);
          statusEl.textContent = '最后更新: ' + (j.data.update_time || '');
        }
      } catch(err) {
        statusEl.textContent = '加载历史数据失败: ' + err;
      }
    }

    // 获取最新趋势（重新计算）
    async function loadData(){
      try {
        const btn = document.getElementById('refreshBtn');
        const loadingIcon = document.getElementById('loadingIcon');
        btn.disabled = true;
        loadingIcon.style.display = 'inline-block';
        statusEl.textContent = '正在计算并获取最新趋势...';

        // 记录点击时的当前数据更新时间
        const currentRes = await fetch('/api/latest');
        const currentData = await currentRes.json();
        const currentUpdateTime = currentData.ok && currentData.data ? currentData.data.update_time : null;

        // 开始计算并等待结果
        const res = await fetch('/api/refresh', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({run: true})
        });
        
        const j = await res.json();
        if(!j.ok){
          statusEl.textContent = '错误: ' + (j.error || 'unknown');
          return;
        }

        // 如果计算已开始，持续轮询直到有新结果
        if(j.triggered_run) {
          let retries = 0;
          const maxRetries = 40; // 最多等待40次，每次3秒 = 2分钟
          
          while(retries < maxRetries) {
            await new Promise(resolve => setTimeout(resolve, 3000)); // 等待3秒
            const pollRes = await fetch('/api/latest');
            const pollData = await pollRes.json();
            
            if(pollData.ok && pollData.data) {
              // 如果更新时间比点击时的时间新，就认为是新数据
              if(pollData.data.update_time !== currentUpdateTime) {
                await displayData(pollData.data);
                statusEl.textContent = '✓ 计算完成，数据已更新';
                return;
              }
            }
            retries++;
            statusEl.textContent = `计算中，请稍候... (${retries}/${maxRetries})`;
          }
          
          // 超时后仍显示最新数据
          const finalRes = await fetch('/api/latest');
          const finalData = await finalRes.json();
          if(finalData.ok && finalData.data) {
            await displayData(finalData.data);
            statusEl.textContent = '计算可能仍在进行，已显示当前数据';
          } else {
            statusEl.textContent = '计算超时，请稍后再试';
          }
          return;
        }

        // 如果没有触发计算，显示当前数据
        if(j.data) {
          await displayData(j.data);
          statusEl.textContent = '✓ 获取成功';
        }
      }catch(err){
        statusEl.textContent = '加载错误: ' + err;
      }finally{
        const btn = document.getElementById('refreshBtn');
        const loadingIcon = document.getElementById('loadingIcon');
        btn.disabled = false;
        loadingIcon.style.display = 'none';
      }
    }

    // 绑定按钮点击事件
    document.getElementById('refreshBtn').addEventListener('click', loadData);

    // 页面加载时，只显示历史数据
    loadLatest();
  </script>
</body>
</html>
